---
title: "Stand Your Ground Law and it's effect on Homicide rates in the US - Interrupted timeseries"
output: html_notebook
---
Stand Your Ground Law and it's effect on Homicide rates in the US - Interrupted timeseries 

1.  Bring in MERS data sets dowloaded from: http://wonder.cdc.gov/
    Centers for Disease Control and Prevention, National Center for Health Statistics. Underlying Cause of Death
    1999-2019 on CDC WONDER Online Database, released in 2020. Data are from the Multiple Cause of Death Files,        1999-2019, as compiled from data provided by the 57 vital statistics jurisdictions through the Vital Statistics     Cooperative Program. Accessed at http://wonder.cdc.gov/ucd-icd10.html on Jun 12, 2021 9:26:53 PM
    
Install packages and open libraries as needed
```{r Install packages and libraries needed}
# install.packages("tidyverse")
# install.packages("RCurl") # Pull data from Github Raw version 
# install.packages("sensitivity")
# install.packages("ggplot2")
# install.packages("readxl")
# install.packages("reshape2")
install.packages("lubridate")
library(lubridate)
library(readxl)
library(data.table)
library(ggplot2)
library(plotly)
library(ggplot2)
library (RCurl)
library (reshape2)
library(dplyr)
library(plotly)
library(rjson)
```

Insert Data. Most can be used as a guide on what to use for different scenarios. Importing text files (https://github.com/copelaa/myrepo/tree/master/Time_Series/Data.

Text files hosted on github and can be manually downloaded and opened from local machine, or pulled directly from Github. 
```{r}
##Text file of homicides in all states by county and race from 1999-2008
HOMICIDE_1999 = "https://raw.githubusercontent.com/copelaa/myrepo/master/Time_Series/Data/Underlying%20Cause%20of%20Death%2C%201999-2008.txt"

HOMICIDE_1999 = read.delim(HOMICIDE_1999, header = TRUE)

##Text file of homicides in all states by county and race from 2009-2019
HOMICIDE_2009 = "https://raw.githubusercontent.com/copelaa/myrepo/master/Time_Series/Data/Underlying%20Cause%20of%20Death%2C%202009-2019.txt"
HOMICIDE_2009 = read.delim(HOMICIDE_2009, header = TRUE)

##Text file of homicides in all states 1999-2019
HOMICIDE_States = "https://raw.githubusercontent.com/copelaa/myrepo/master/Time_Series/Data/Underlying%20Cause%20of%20Death%2C%201999-2019%20States.txt"
HOMICIDE_States = read.delim(HOMICIDE_States, header = TRUE)

##Country file to plot over country image
data <- fromJSON(file="https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json")
data$features[[1]]


#Merge dataframes so years are 1999->2019
total_HOMICIDE <- rbind(HOMICIDE_1999, HOMICIDE_2009)
```

Add Stand Your Ground Starting dates for States:
```{r}
total_HOMICIDE$SYG_Start <- NA



#Alabama
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Alabama"] <- as.Date("06/01/2006",format = "%m/%d/%Y")

#Alaska
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Alaska"] <- as.Date("09/13/2006",format = "%m/%d/%Y")

#Arizona
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Arizona"] <- as.Date("04/24/2006",format = "%m/%d/%Y")

#Arkansas
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Arkansas"] <- as.Date("03/03/2021",format = "%m/%d/%Y")

#Colorado
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Colorado"] <- as.Date("01/01/2019",format = "%m/%d/%Y")

#Florida
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Florida"] <- as.Date("10/01/2005",format = "%m/%d/%Y")

#Georgia
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Georgia"] <- as.Date("07/01/2006",format = "%m/%d/%Y")

#Idaho
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Idaho"] <- as.Date("07/01/2006",format = "%m/%d/%Y")

#Illinois
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Illinois"] <- as.Date("07/28/2004",format = "%m/%d/%Y")

#Indiana 
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Indiana"] <- as.Date("07/01/2006",format = "%m/%d/%Y")

#Iowa
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Iowa"] <- as.Date("04/18/2017",format = "%m/%d/%Y")

#Kansas
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Kansas"] <- as.Date("07/01/2006",format = "%m/%d/%Y")

#Kentucky
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Kentucky"] <- as.Date("07/12/2006",format = "%m/%d/%Y")

#Louisiana
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Louisiana"] <- as.Date("08/15/2006",format = "%m/%d/%Y")

#Michigan
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Michigan"] <- as.Date("10/01/2006",format = "%m/%d/%Y")

#Mississippi
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Mississippi"] <- as.Date("07/01/2006",format = "%m/%d/%Y")

#Missouri
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Missouri"] <- as.Date("08/28/2007",format = "%m/%d/%Y")

#Montana
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Montana"] <- as.Date("04/27/2009",format = "%m/%d/%Y")

#Nevada
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Nevada"] <- as.Date("10/01/2011",format = "%m/%d/%Y")

#New Hampshire 
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "New Hampshire"] <- as.Date("11/13/2011",format = "%m/%d/%Y")

#North Carolina
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "North Carolina"] <- as.Date("12/01/2011",format = "%m/%d/%Y")

#North Dakota
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "North Dakota"] <- as.Date("08/01/2007",format = "%m/%d/%Y")

#Ohio
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Ohio"] <- as.Date("09/09/2008",format = "%m/%d/%Y")

#Oklahoma
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Oklahoma"] <- as.Date("11/01/2006",format = "%m/%d/%Y")

#Pennsylvania
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Pennsylvania"] <- as.Date("06/01/2011",format = "%m/%d/%Y")

#South Carolina
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "South Carolina"] <- as.Date("06/09/2006",format = "%m/%d/%Y")

#South Dakota
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "South Dakota"] <- as.Date("07/01/2006",format = "%m/%d/%Y")

#Tennessee
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Tennessee"] <- as.Date("05/22/2007",format = "%m/%d/%Y")

#Texas
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Texas"] <- as.Date("09/01/2007",format = "%m/%d/%Y")

#Utah
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Utah"] <- as.Date("03/02/1994",format = "%m/%d/%Y")

#West Virginia
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "West Virginia" ]<- as.Date("02/28/2008",format = "%m/%d/%Y")
 
#Wyoming                        
total_HOMICIDE$SYG_Start[total_HOMICIDE$State == "Wyoming"] <- as.Date("07/01/2008",format = "%m/%d/%Y")     

#Change Date format to show as dates in Dataframe
total_HOMICIDE$SYG_Start<- as_date(total_HOMICIDE$SYG_Start, origin = lubridate::origin)


#Check States with No SYG Laws
NO_SYG<- data.frame(total_HOMICIDE$State[is.na(total_HOMICIDE$SYG_Start)])
colnames(NO_SYG)[1] <- "State"
NO_SYG<- NO_SYG[!duplicated(NO_SYG[ ,c("State")]),]
  

#Check States with SYG Laws
SYG<- data.frame(total_HOMICIDE[ ,c(4,23)])
SYG<- na.omit(SYG)
SYG<- as.data.frame(SYG[ ,1])
colnames(SYG)[1] <- "State"
SYG<- SYG[!duplicated(SYG[ ,c("State")]),]       
States<- total_HOMICIDE[!duplicated(total_HOMICIDE[ ,c("State")]),4]

#Separate year from datetime:
total_HOMICIDE$SYG <- format(total_HOMICIDE$SYG_Start, format="%Y")

```

State Dataframe for actual use for TS analysis 
```{r}
HOMICIDE_States$SYG_Start <- NA

#Add SYG Year and SYG Start date to State Dataframe from Total Homicide dataframe
SYG_Date = data.frame(State=c(total_HOMICIDE$State) , SYG= as.numeric(total_HOMICIDE$SYG), SYG_Start=as.Date(total_HOMICIDE$SYG_Start))
SYG_Date <- SYG_Date[!duplicated(SYG_Date[ ,c("State")]),1:3]
row.names(SYG_Date) <- SYG_Date$State                     # Convert column to row names
SYG_Date$State<-NULL
HOMICIDE_States$SYG<-SYG_Date[HOMICIDE_States$State,"SYG"]
HOMICIDE_States$SYG_Start<-SYG_Date[HOMICIDE_States$State, "SYG_Start"]

#Check States with No SYG Laws
NO_SYG_states<- data.frame(HOMICIDE_States$State[is.na(HOMICIDE_States$SYG_Start)])
colnames(NO_SYG_states)[1] <- "State"
NO_SYG_states<- NO_SYG_states[!duplicated(NO_SYG_states[ ,c("State")]),]
  
#Check States with SYG Laws
SYG_states<- data.frame(HOMICIDE_States[ ,c(4,23)])
SYG_states<- na.omit(SYG_states)
SYG_states<- as.data.frame(SYG_states[ ,1])
colnames(SYG_states)[1] <- "State"
SYG_states<- SYG_states[!duplicated(SYG_states[ ,c("State")]),]       
States<- HOMICIDE_States[!duplicated(HOMICIDE_States[ ,c("State")]),4]

#Make an Intervention column
HOMICIDE_States$I<- NA
Intervention <- function(x) {if (is.na(x)) {0} else {1}}
HOMICIDE_States$I<-sapply(HOMICIDE_States$SYG, Intervention)

#Add End date
HOMICIDE_States$END<- c(2019)



#Create Time Since intervention 
HOMICIDE_States$P <- (HOMICIDE_States$END-HOMICIDE_States$SYG)

```

Data Exploration: 

Plot Homicide level over USA Image
```{r}
test <- read.csv("https://raw.githubusercontent.com/plotly/datasets/master/2011_us_ag_exports.csv")

HOMICIDE_States_2009<- HOMICIDE_States[ which(HOMICIDE_States$Year=="2009"), ]
# ADD State codes to data frame 2009
x=data.frame(row.names=c(test$state) , val=c(test$code))
HOMICIDE_States_2009$State_AB<- x[HOMICIDE_States_2009$State,]

#Map on US Map
HOMICIDE_States_2009$hover <- with(HOMICIDE_States_2009, paste(State, '<br>', "Deaths", Deaths, "Population", Population, "<br>",
                           "Age Adjusted Rate", Age.Adjusted.Rate))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

fig <- plot_geo(HOMICIDE_States_2009, locationmode = 'USA-states')
fig <- fig %>% add_trace(
    z = ~Deaths, text = ~hover, locations = ~State_AB,
    color = ~Deaths, colors = 'Purples'
  )
fig <- fig %>% colorbar(title = "Homicide by firearm")
fig <- fig %>% layout(
    title = '2009 Homicide Rates in the USA <br>(Hover for breakdown)',
    geo = g
  )

fig
```

```{r Plot intial time series}

plot(HOMICIDE_States$SYG, HOMICIDE_States$Deaths,
      bty="n", pch=19, col="gray",
      ylim = c(min(HOMICIDE_States$Deaths, na.rm = TRUE), max(HOMICIDE_States$Deaths, na.rm = TRUE)), xlim=c(2000,2020),
      xlab = "Time (years)", 
      ylab = "Homicide Deaths by Firearms" )

# Line marking the interruption
abline( v=2006, col="firebrick", lty=2 )
text( 200, 300, "Start of Stand your Ground Laws", col="firebrick", cex=1.3, pos=4 )

# Add the regression line
ts <- lm( Deaths ~ SYG + D + P, data=dataTS )
lines( dataTS$T, ts$fitted.values, col="steelblue", lwd=2 )

```

```{r Check for correlation among points}

attach(total_HOMICIDE)
plot(Deaths, Year, main="Scatterplot Example",
   xlab="Deaths ", ylab="Year", pch=19)
regTS_OK <- lm(Deaths ~ Year, data = total_HOMICIDE)
# Calculate a simple regression where birth rate depends only on time 
print(regTS_OK)
summary(regTS_OK)
plot(resid( regTS_OK ))

```

